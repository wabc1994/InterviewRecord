# 一个SQL查询是如何执行的

在蚂蚁金服三面的时候没有回答出来的这个问题的本质

1. 先从数据库的架构开始说起，查看是否命中缓存， 如果命中就缓存就不再服务器下面的层次了， 
从MySQL的语法分析器，到优化器，到执行器，如果缓存不中的话，就要走这些流程，然后server层调用innodb的查询接口，将数据查出来，
2. 明确先写入日志在写磁盘， 
3. WAL技术
4. 先内存当中的数据然后是磁盘， 内存当中就是缓存区的概念，先修改缓冲区当中的页，之后再考虑刷新到磁盘

> redo log 两阶段提交， binglong 是在插入在redo log 提交之前写入的
这里面到底有什么东西你要讲清楚，

buffer pool log buffer都是在内存当中的

## 两种查询
1. 普通select语句，一致非锁定读，也可以称为快照读，其实就是普通的读取即普通SELECT语句。快照读是其实说白了就是MVCC,乐观锁，不加读的机制，

2. select.... for update关系 加排他锁的机制，分为表锁和行锁,行锁被

[一条SQL查询是如何执行的](https://blog.csdn.net/megustas_jjc/article/details/84380108)

## SQL执行很慢的原因

也分为好几种吧，偶尔很慢，还是一直很慢的情况

一个 SQL 执行的很慢，我们要分两种情况讨论：

1. 大多数情况下很正常，偶尔很慢，则有如下原因

    - 数据库在刷新脏页，例如 redo log 写满了需要同步到磁盘。

    - 执行的时候，遇到锁，如表锁、行锁。锁等待机制

2. 这条 SQL 语句一直执行的很慢，则有如下原因。

    - 没有用上索引：例如该字段没有索引；由于对字段进行运算、函数操作导致无法用索引。

    - 数据库选错了索引



1. 可以查看执行计划explain， 查看是否索引的执行请 type，如果执行计划是all, 或者index 这种就是基本是全表扫描，最基本的要达到range，也就是范围查找级别的
2. 如何缓冲池 buffer pool的空间不够，如何数据库正在忙于往磁盘当中刷新dirty page 的话那么也会导致SQL变得很慢的，
3. 数据库执行也有可能是选错索引的